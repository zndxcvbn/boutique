<UserControl x:Class="Boutique.Views.DistributionCreateTabView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="clr-namespace:Boutique.ViewModels"
             xmlns:models="clr-namespace:Boutique.Models"
             xmlns:util="clr-namespace:Boutique.Utilities"
             xmlns:controls="clr-namespace:Boutique.Controls"
             xmlns:themes="clr-namespace:Boutique.Themes"
             mc:Ignorable="d"
             d:DataContext="{d:DesignInstance vm:DistributionEditTabViewModel, IsDesignTimeCreatable=False}"
             x:Name="Root"
             d:DesignHeight="600"
             d:DesignWidth="1100">
    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="2*" />
            <ColumnDefinition Width="10" />
            <ColumnDefinition Width="3*" />
        </Grid.ColumnDefinitions>

        <!-- Distribution Entries Editor -->
        <GroupBox Grid.Column="0" Header="Distribution Entries" Padding="6">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="*" />
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                </Grid.RowDefinitions>

                <!-- File Selector -->
                <StackPanel Grid.Row="0" Margin="0,0,0,6">
                    <StackPanel Orientation="Horizontal" Margin="0,0,0,6">
                        <TextBlock Text="File:" Style="{DynamicResource {x:Static themes:ResourceKeys.LabelTextStyleKey}}" />
                        <ComboBox ItemsSource="{Binding DropdownItems}"
                                  SelectedItem="{Binding SelectedDropdownItem, Mode=TwoWay}"
                                  MinWidth="350" Margin="0,0,6,0"
                                  MaxDropDownHeight="400"
                                  IsSynchronizedWithCurrentItem="False">
                            <ComboBox.Resources>
                                <!-- Template for group headers (non-selectable) -->
                                <DataTemplate DataType="{x:Type models:DistributionGroupHeader}">
                                    <TextBlock Text="{Binding GroupName}"
                                               FontWeight="SemiBold"
                                               FontSize="11"
                                               Foreground="{DynamicResource {x:Static util:ResourceKeys.BrushTextSecondary}}"
                                               Padding="0,4,0,2" />
                                </DataTemplate>

                                <!-- Template for file items -->
                                <DataTemplate DataType="{x:Type models:DistributionFileItem}">
                                    <TextBlock Text="{Binding DisplayText}" Padding="12,0,0,0" />
                                </DataTemplate>

                                <!-- Template for new file item -->
                                <DataTemplate DataType="{x:Type models:DistributionNewFileItem}">
                                    <TextBlock Text="{Binding DisplayText}" FontStyle="Italic" />
                                </DataTemplate>
                            </ComboBox.Resources>
                            <ComboBox.ItemContainerStyle>
                                <Style TargetType="ComboBoxItem" BasedOn="{StaticResource {x:Type ComboBoxItem}}">
                                    <Style.Triggers>
                                        <!-- Make headers non-selectable -->
                                        <DataTrigger Binding="{Binding IsSelectable}" Value="False">
                                            <Setter Property="IsEnabled" Value="False" />
                                            <Setter Property="IsHitTestVisible" Value="False" />
                                            <Setter Property="Focusable" Value="False" />
                                            <Setter Property="Background" Value="Transparent" />
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </ComboBox.ItemContainerStyle>
                        </ComboBox>
                        <TextBlock Text="Format:" Style="{DynamicResource {x:Static themes:ResourceKeys.LabelTextStyleKey}}" Margin="12,0,6,0" />
                        <ComboBox ItemsSource="{Binding AvailableFormats}"
                                  SelectedItem="{Binding DistributionFormat, Mode=TwoWay}"
                                  MinWidth="120" Margin="0,0,6,0">
                            <ComboBox.ItemTemplate>
                                <DataTemplate>
                                    <TextBlock Text="{Binding Converter={StaticResource DistributionFileTypeConverter}}" />
                                </DataTemplate>
                            </ComboBox.ItemTemplate>
                            <ComboBox.ItemContainerStyle>
                                <Style TargetType="ComboBoxItem" BasedOn="{StaticResource {x:Type ComboBoxItem}}">
                                    <Setter Property="ToolTipService.ShowOnDisabled" Value="True" />
                                    <Style.Triggers>
                                        <MultiDataTrigger>
                                            <MultiDataTrigger.Conditions>
                                                <Condition Binding="{Binding}" Value="SkyPatcher" />
                                                <Condition Binding="{Binding DataContext.HasChanceBasedEntries, RelativeSource={RelativeSource AncestorType=ComboBox}}" Value="True" />
                                            </MultiDataTrigger.Conditions>
                                            <Setter Property="IsEnabled" Value="False" />
                                            <Setter Property="ToolTip" Value="SkyPatcher does not support chance-based distribution. Disable chance on all entries to use this format." />
                                        </MultiDataTrigger>
                                        <MultiDataTrigger>
                                            <MultiDataTrigger.Conditions>
                                                <Condition Binding="{Binding}" Value="SkyPatcher" />
                                                <Condition Binding="{Binding DataContext.HasKeywordDistributions, RelativeSource={RelativeSource AncestorType=ComboBox}}" Value="True" />
                                            </MultiDataTrigger.Conditions>
                                            <Setter Property="IsEnabled" Value="False" />
                                            <Setter Property="ToolTip" Value="SkyPatcher does not support keyword distribution. Change all entries to Outfit type to use this format." />
                                        </MultiDataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </ComboBox.ItemContainerStyle>
                        </ComboBox>
                    </StackPanel>
                    <StackPanel Orientation="Horizontal" Visibility="{Binding ShowNewFileNameInput, Converter={StaticResource BoolToVisConverter}}">
                        <TextBlock Text="Filename:" Style="{DynamicResource {x:Static themes:ResourceKeys.LabelTextStyleKey}}" />
                        <TextBox Text="{Binding NewFileName, UpdateSourceTrigger=PropertyChanged}" VerticalAlignment="Center" MinWidth="200" Margin="0,0,6,0" />
                        <Button Content="Browse..." Command="{Binding SelectDistributionFilePathCommand}" Padding="8,2" />
                    </StackPanel>
                    <StackPanel Orientation="Horizontal" Margin="0,2,0,0"
                                Visibility="{Binding ShowNewFileNameInput, Converter={StaticResource BoolToVisConverter}}">
                        <TextBlock Text="Saves as:" Style="{DynamicResource {x:Static themes:ResourceKeys.SecondaryTextStyleKey}}" Margin="0,0,4,0" FontSize="11" />
                        <TextBlock Text="{Binding ActualFileName}" FontFamily="Consolas" FontSize="11" Foreground="{StaticResource Brush.TextSecondary}" />
                    </StackPanel>
                    <!-- Conflict Warning -->
                    <Border Style="{DynamicResource {x:Static themes:ResourceKeys.WarningPanelStyleKey}}" Margin="0,6,0,0"
                            Visibility="{Binding HasConflicts, Converter={StaticResource BoolToVisConverter}}">
                        <StackPanel>
                            <TextBlock Text="{Binding ConflictSummary}" TextWrapping="Wrap" Foreground="#CC6600" FontSize="11" />
                            <StackPanel Orientation="Horizontal" Margin="0,4,0,0">
                                <TextBlock Text="Suggested: " Foreground="#CC6600" FontWeight="Bold" FontSize="11" />
                                <TextBlock Text="{Binding SuggestedFileName}" Foreground="#CC6600" FontFamily="Consolas" FontWeight="Bold" FontSize="11" />
                            </StackPanel>
                        </StackPanel>
                    </Border>
                </StackPanel>

                <!-- Action Buttons -->
                <StackPanel Grid.Row="1" Orientation="Horizontal" Margin="0,0,0,6">
                    <Button Content="Add Entry" Command="{Binding AddDistributionEntryCommand}" Margin="0,0,6,0" Padding="8,2" />
                    <Button Content="Save File" Command="{Binding SaveDistributionFileCommand}" Margin="0,0,6,0" Padding="8,2" />
                    <Button Content="ðŸ“‹ Paste Filter" Command="{Binding PasteFilterToEntryCommand}" Padding="8,2"
                            ToolTip="{Binding CopiedFilter.Description, StringFormat='Paste filter: {0}', FallbackValue='Paste copied filter from NPCs tab'}" />
                </StackPanel>

                <!-- Distribution Entries List -->
                <ListBox Grid.Row="2" ItemsSource="{Binding DistributionEntries}"
                         VirtualizingPanel.IsVirtualizing="True"
                         VirtualizingPanel.VirtualizationMode="Recycling"
                         VirtualizingPanel.ScrollUnit="Pixel"
                         ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                         ScrollViewer.VerticalScrollBarVisibility="Auto"
                         Background="Transparent" BorderThickness="0"
                         HorizontalContentAlignment="Stretch"
                         ItemContainerStyle="{DynamicResource {x:Static themes:ResourceKeys.PlainListBoxItemStyleKey}}">
                    <ListBox.ItemTemplate>
                        <DataTemplate>
                            <Border Style="{DynamicResource {x:Static themes:ResourceKeys.SelectableEntryStyleKey}}">
                                <Border.Resources>
                                    <Style TargetType="Border" BasedOn="{DynamicResource {x:Static themes:ResourceKeys.SelectableEntryStyleKey}}">
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding IsSelected}" Value="True">
                                                <Setter Property="Background" Value="{StaticResource Brush.CardBackground}" />
                                                <Setter Property="BorderBrush" Value="{StaticResource Brush.Accent}" />
                                                <Setter Property="BorderThickness" Value="2" />
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Border.Resources>
                                <StackPanel>
                                    <!-- Header: Assign + Type + Outfit/Keyword + Chance + Preview + Remove -->
                                    <StackPanel Orientation="Horizontal" Margin="0,0,0,2">
                                        <RadioButton Content="Assign" IsChecked="{Binding IsSelected}"
                                                     Command="{Binding DataContext.SelectEntryCommand, ElementName=Root}"
                                                     CommandParameter="{Binding}" Margin="0,0,8,0" FontWeight="Bold" VerticalAlignment="Center" />
                                        <ComboBox ItemsSource="{x:Static vm:DistributionEntryViewModel.TypeOptions}"
                                                  SelectedItem="{Binding Type, Mode=TwoWay}"
                                                  MinWidth="70" Height="22" VerticalContentAlignment="Center" Margin="0,0,6,0" />
                                        <!-- Outfit selector (visible when Type=Outfit) -->
                                        <StackPanel Orientation="Horizontal" Visibility="{Binding IsOutfitDistribution, Converter={StaticResource BoolToVisConverter}}">
                                            <TextBlock Text="Outfit:" VerticalAlignment="Center" Margin="0,0,4,0" />
                                            <controls:FilterableSelector
                                                      ItemsSource="{Binding DataContext.AvailableOutfits, ElementName=Root}"
                                                      SelectedItem="{Binding SelectedOutfit, Mode=TwoWay}"
                                                      DisplayMemberPath="EditorID"
                                                      FilterPath="EditorID"
                                                      MinWidth="140" Margin="0,0,4,0"
                                                      MaxDropDownHeight="300"
                                                      DropDownOpened="FilterableSelector_DropDownOpened" />
                                        </StackPanel>
                                        <!-- Keyword selector (visible when Type=Keyword) -->
                                        <StackPanel Orientation="Horizontal" Visibility="{Binding IsKeywordDistribution, Converter={StaticResource BoolToVisConverter}}">
                                            <TextBlock Text="Keyword:" VerticalAlignment="Center" Margin="0,0,4,0" />
                                            <ComboBox ItemsSource="{Binding DataContext.AvailableKeywords, ElementName=Root}"
                                                      Text="{Binding KeywordToDistribute, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                                      DisplayMemberPath="EditorID"
                                                      IsEditable="True"
                                                      MinWidth="160" Height="22" VerticalContentAlignment="Center" Margin="0,0,4,0"
                                                      ToolTip="Select existing keyword or type a new EditorID for virtual keywords" />
                                        </StackPanel>
                                        <CheckBox Content="%" IsChecked="{Binding UseChance, Mode=TwoWay}" VerticalAlignment="Center" Margin="0,0,2,0" ToolTip="Use Chance" />
                                        <TextBox Text="{Binding Chance, UpdateSourceTrigger=PropertyChanged}" Width="32" Height="22"
                                                 IsEnabled="{Binding UseChance}" Margin="0,0,4,0" ToolTip="Chance (0-100)"
                                                 VerticalAlignment="Center" VerticalContentAlignment="Center" Padding="2,0" />
                                        <Button ToolTip="Preview Outfit" Style="{DynamicResource {x:Static themes:ResourceKeys.IconButtonStyleKey}}"
                                                Command="{Binding DataContext.PreviewEntryCommand, ElementName=Root}" CommandParameter="{Binding}"
                                                Visibility="{Binding IsOutfitDistribution, Converter={StaticResource BoolToVisConverter}}">
                                            <Image Source="pack://application:,,,/Assets/eye.png" Width="12" Height="12" />
                                        </Button>
                                        <Button Command="{Binding RemoveCommand}" Style="{DynamicResource {x:Static themes:ResourceKeys.InlineRemoveButtonStyleKey}}"
                                                ToolTip="Remove Entry" Height="22" Width="22" Margin="2,0,0,0" />
                                    </StackPanel>

                                    <!-- NPCs (hidden when empty) -->
                                    <StackPanel Orientation="Horizontal" Margin="0,2,0,0"
                                                Visibility="{Binding SelectedNpcs.Count, Converter={StaticResource CollectionCountToVisConverter}}">
                                        <TextBlock Text="NPCs:" Style="{DynamicResource {x:Static themes:ResourceKeys.SecondaryTextStyleKey}}" Margin="0,0,4,0" FontSize="11" />
                                        <ItemsControl ItemsSource="{Binding SelectedNpcs}" VerticalAlignment="Center">
                                            <ItemsControl.ItemsPanel>
                                                <ItemsPanelTemplate><StackPanel /></ItemsPanelTemplate>
                                            </ItemsControl.ItemsPanel>
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate>
                                                    <Border Style="{DynamicResource {x:Static themes:ResourceKeys.FilterChipStyleKey}}">
                                                        <StackPanel Orientation="Horizontal">
                                                            <TextBlock Text="{Binding DisplayName}" FontSize="11" VerticalAlignment="Center" />
                                                            <TextBlock Text="{Binding FormKeyString}" Style="{DynamicResource {x:Static themes:ResourceKeys.FormKeyTextStyleKey}}" Margin="4,0,0,0" FontSize="9" />
                                                            <Button Click="RemoveNpc_Click" Tag="{Binding}"
                                                                    Style="{DynamicResource {x:Static themes:ResourceKeys.InlineRemoveButtonStyleKey}}" Margin="3,0,0,0" />
                                                        </StackPanel>
                                                    </Border>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>
                                    </StackPanel>

                                    <!-- Factions (hidden when empty) -->
                                    <StackPanel Orientation="Horizontal" Margin="0,2,0,0"
                                                Visibility="{Binding SelectedFactions.Count, Converter={StaticResource CollectionCountToVisConverter}}">
                                        <TextBlock Text="Factions:" Style="{DynamicResource {x:Static themes:ResourceKeys.SecondaryTextStyleKey}}" Margin="0,0,4,0" FontSize="11" />
                                        <ItemsControl ItemsSource="{Binding SelectedFactions}" VerticalAlignment="Center">
                                            <ItemsControl.ItemsPanel>
                                                <ItemsPanelTemplate><StackPanel /></ItemsPanelTemplate>
                                            </ItemsControl.ItemsPanel>
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate>
                                                    <Border Style="{DynamicResource {x:Static themes:ResourceKeys.FilterChipStyleKey}}">
                                                        <StackPanel Orientation="Horizontal">
                                                            <TextBlock Text="{Binding DisplayName}" FontSize="11" VerticalAlignment="Center" />
                                                            <TextBlock Text="{Binding FormKeyString}" Style="{DynamicResource {x:Static themes:ResourceKeys.FormKeyTextStyleKey}}" Margin="4,0,0,0" FontSize="9" />
                                                            <Button Click="RemoveFaction_Click" Tag="{Binding}"
                                                                    Style="{DynamicResource {x:Static themes:ResourceKeys.InlineRemoveButtonStyleKey}}" Margin="3,0,0,0" />
                                                        </StackPanel>
                                                    </Border>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>
                                    </StackPanel>

                                    <!-- Keywords (hidden when empty) -->
                                    <StackPanel Orientation="Horizontal" Margin="0,2,0,0"
                                                Visibility="{Binding SelectedKeywords.Count, Converter={StaticResource CollectionCountToVisConverter}}">
                                        <TextBlock Text="Keywords:" Style="{DynamicResource {x:Static themes:ResourceKeys.SecondaryTextStyleKey}}" Margin="0,0,4,0" FontSize="11" />
                                        <ItemsControl ItemsSource="{Binding SelectedKeywords}" VerticalAlignment="Center">
                                            <ItemsControl.ItemsPanel>
                                                <ItemsPanelTemplate><StackPanel /></ItemsPanelTemplate>
                                            </ItemsControl.ItemsPanel>
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate>
                                                    <Border Style="{DynamicResource {x:Static themes:ResourceKeys.FilterChipStyleKey}}">
                                                        <StackPanel Orientation="Horizontal">
                                                            <TextBlock Text="{Binding DisplayName}" FontSize="11" VerticalAlignment="Center" />
                                                            <TextBlock Text="{Binding FormKeyString}" Style="{DynamicResource {x:Static themes:ResourceKeys.FormKeyTextStyleKey}}" Margin="4,0,0,0" FontSize="9" />
                                                            <Button Click="RemoveKeyword_Click" Tag="{Binding}"
                                                                    Style="{DynamicResource {x:Static themes:ResourceKeys.InlineRemoveButtonStyleKey}}" Margin="3,0,0,0" />
                                                        </StackPanel>
                                                    </Border>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>
                                    </StackPanel>

                                    <!-- Races (hidden when empty) -->
                                    <StackPanel Orientation="Horizontal" Margin="0,2,0,0"
                                                Visibility="{Binding SelectedRaces.Count, Converter={StaticResource CollectionCountToVisConverter}}">
                                        <TextBlock Text="Races:" Style="{DynamicResource {x:Static themes:ResourceKeys.SecondaryTextStyleKey}}" Margin="0,0,4,0" FontSize="11" />
                                        <ItemsControl ItemsSource="{Binding SelectedRaces}" VerticalAlignment="Center">
                                            <ItemsControl.ItemsPanel>
                                                <ItemsPanelTemplate><StackPanel /></ItemsPanelTemplate>
                                            </ItemsControl.ItemsPanel>
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate>
                                                    <Border Style="{DynamicResource {x:Static themes:ResourceKeys.FilterChipStyleKey}}">
                                                        <StackPanel Orientation="Horizontal">
                                                            <TextBlock Text="{Binding DisplayName}" FontSize="11" VerticalAlignment="Center" />
                                                            <TextBlock Text="{Binding FormKeyString}" Style="{DynamicResource {x:Static themes:ResourceKeys.FormKeyTextStyleKey}}" Margin="4,0,0,0" FontSize="9" />
                                                            <Button Click="RemoveRace_Click" Tag="{Binding}"
                                                                    Style="{DynamicResource {x:Static themes:ResourceKeys.InlineRemoveButtonStyleKey}}" Margin="3,0,0,0" />
                                                        </StackPanel>
                                                    </Border>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>
                                    </StackPanel>

                                    <!-- Classes (hidden when empty) -->
                                    <StackPanel Orientation="Horizontal" Margin="0,2,0,0"
                                                Visibility="{Binding SelectedClasses.Count, Converter={StaticResource CollectionCountToVisConverter}}">
                                        <TextBlock Text="Classes:" Style="{DynamicResource {x:Static themes:ResourceKeys.SecondaryTextStyleKey}}" Margin="0,0,4,0" FontSize="11" />
                                        <ItemsControl ItemsSource="{Binding SelectedClasses}" VerticalAlignment="Center">
                                            <ItemsControl.ItemsPanel>
                                                <ItemsPanelTemplate><StackPanel /></ItemsPanelTemplate>
                                            </ItemsControl.ItemsPanel>
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate>
                                                    <Border Style="{DynamicResource {x:Static themes:ResourceKeys.FilterChipStyleKey}}">
                                                        <StackPanel Orientation="Horizontal">
                                                            <TextBlock Text="{Binding DisplayName}" FontSize="11" VerticalAlignment="Center" />
                                                            <TextBlock Text="{Binding FormKeyString}" Style="{DynamicResource {x:Static themes:ResourceKeys.FormKeyTextStyleKey}}" Margin="4,0,0,0" FontSize="9" />
                                                            <Button Click="RemoveClass_Click" Tag="{Binding}"
                                                                    Style="{DynamicResource {x:Static themes:ResourceKeys.InlineRemoveButtonStyleKey}}" Margin="3,0,0,0" />
                                                        </StackPanel>
                                                    </Border>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>
                                    </StackPanel>

                                    <!-- Traits: Gender, Unique -->
                                    <StackPanel Orientation="Horizontal" Margin="0,4,0,0">
                                        <TextBlock Text="Traits:" Style="{DynamicResource {x:Static themes:ResourceKeys.SecondaryTextStyleKey}}" Margin="0,0,6,0" FontSize="11" />
                                        <TextBlock Text="Gender:" VerticalAlignment="Center" Margin="0,0,4,0" FontSize="11" />
                                        <ComboBox ItemsSource="{x:Static vm:DistributionEntryViewModel.GenderOptions}"
                                                  SelectedItem="{Binding Gender, Mode=TwoWay}"
                                                  MinWidth="70" Height="22" FontSize="11" VerticalContentAlignment="Center" Margin="0,0,12,0" />
                                        <TextBlock Text="Unique:" VerticalAlignment="Center" Margin="0,0,4,0" FontSize="11" />
                                        <ComboBox ItemsSource="{x:Static vm:DistributionEntryViewModel.UniqueOptions}"
                                                  SelectedItem="{Binding Unique, Mode=TwoWay}"
                                                  MinWidth="100" Height="22" FontSize="11" VerticalContentAlignment="Center" Margin="0,0,12,0" />
                                        <TextBlock Text="Level/Skill:" VerticalAlignment="Center" Margin="0,0,4,0" FontSize="11" />
                                        <TextBox Text="{Binding LevelFilters, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                                 Width="100" Height="22" FontSize="11" VerticalContentAlignment="Center"
                                                 ToolTip="SPID level/skill filters. Examples: 5/20 (level range), 12(85/999) (Alteration skill 85+)" />
                                    </StackPanel>
                                </StackPanel>
                            </Border>
                        </DataTemplate>
                    </ListBox.ItemTemplate>
                </ListBox>

                <!-- Parse Errors -->
                <Expander Grid.Row="3"
                          Visibility="{Binding HasParseErrors, Converter={StaticResource BoolToVisConverter}}"
                          IsExpanded="True" Margin="0,6,0,0">
                    <Expander.Header>
                        <TextBlock>
                            <Run Text="{Binding ActualParseErrors.Count, Mode=OneWay}" />
                            <Run Text=" parsing error(s) - these lines will be preserved on save" />
                        </TextBlock>
                    </Expander.Header>
                    <Border Padding="6" Background="{DynamicResource Brush.Error.Background}" BorderBrush="{DynamicResource Brush.Error.Border}" BorderThickness="1" CornerRadius="0,0,4,4">
                        <ItemsControl ItemsSource="{Binding ActualParseErrors}" MaxHeight="150">
                            <ItemsControl.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <VirtualizingStackPanel />
                                </ItemsPanelTemplate>
                            </ItemsControl.ItemsPanel>
                            <ItemsControl.Template>
                                <ControlTemplate TargetType="ItemsControl">
                                    <ScrollViewer VerticalScrollBarVisibility="Auto">
                                        <ItemsPresenter />
                                    </ScrollViewer>
                                </ControlTemplate>
                            </ItemsControl.Template>
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <StackPanel Margin="0,2">
                                        <TextBox IsReadOnly="True" BorderThickness="0" Background="Transparent" FontFamily="Consolas" FontSize="11"
                                                 Foreground="{DynamicResource Brush.Error.Title}" IsReadOnlyCaretVisible="False"
                                                 Text="{Binding ErrorHeader, Mode=OneWay}" />
                                        <TextBox IsReadOnly="True" BorderThickness="0" Background="Transparent" FontFamily="Consolas" FontSize="10"
                                                 Foreground="{DynamicResource Brush.Error.Text}" IsReadOnlyCaretVisible="False"
                                                 Text="{Binding LineContent, Mode=OneWay}" ToolTip="{Binding LineContent}" Margin="12,0,0,0" />
                                    </StackPanel>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </Border>
                </Expander>

                <!-- Preview (Collapsible) -->
                <Expander Grid.Row="4" Header="File Preview" IsExpanded="{Binding IsFilePreviewExpanded, Mode=TwoWay}" Margin="0,6,0,0">
                    <Border Padding="6" Background="{StaticResource Brush.CardBackground}"
                            BorderBrush="{StaticResource Brush.Border}" BorderThickness="1" CornerRadius="0,0,4,4">
                        <TextBox Text="{Binding DistributionFileContent, Mode=OneWay}" IsReadOnly="True" TextWrapping="Wrap" AcceptsReturn="True"
                                 VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Auto" FontFamily="Consolas" FontSize="11" MinHeight="120" MaxHeight="200" />
                    </Border>
                </Expander>
            </Grid>
        </GroupBox>

        <!-- Filter Selection -->
        <GroupBox Grid.Column="2" Header="Distribution Filters" Padding="6">
            <TabControl>
                <!-- NPCs Tab -->
                <TabItem Header="NPCs">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="*" />
                            <RowDefinition Height="Auto" />
                        </Grid.RowDefinitions>
                        <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0,0,0,6">
                            <TextBlock Text="Search:" Style="{DynamicResource {x:Static themes:ResourceKeys.LabelTextStyleKey}}" />
                            <TextBox Text="{Binding NpcSearchText, UpdateSourceTrigger=PropertyChanged}" MinWidth="200" />
                        </StackPanel>
                        <DataGrid Grid.Row="1" ItemsSource="{Binding FilteredNpcs}" AutoGenerateColumns="False" CanUserAddRows="False" CanUserDeleteRows="False"
                                  CanUserSortColumns="True" SelectionMode="Single" EnableRowVirtualization="True" EnableColumnVirtualization="True">
                            <DataGrid.Columns>
                                <DataGridCheckBoxColumn Header="" Binding="{Binding IsSelected, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" Width="Auto" />
                                <DataGridTextColumn Header="Name" Binding="{Binding DisplayName}" Width="*" IsReadOnly="True" />
                                <DataGridTextColumn Header="EditorID" Binding="{Binding EditorID}" Width="200" IsReadOnly="True" />
                                <DataGridTextColumn Header="FormKey" Binding="{Binding FormKeyString}" Width="150" IsReadOnly="True"
                                                    ElementStyle="{DynamicResource {x:Static themes:ResourceKeys.DataGridFormKeyColumnStyleKey}}" />
                                <DataGridTextColumn Header="Mod" Binding="{Binding ModDisplayName}" Width="150" IsReadOnly="True"
                                                    ElementStyle="{DynamicResource {x:Static themes:ResourceKeys.DataGridSecondaryColumnStyleKey}}" />
                            </DataGrid.Columns>
                        </DataGrid>
                        <StackPanel Grid.Row="2" Margin="0,6,0,0">
                            <TextBlock Text="{Binding SelectedEntry.SelectedOutfit.EditorID, StringFormat='Target Entry: {0}', FallbackValue='Target Entry: (None selected)'}"
                                       FontStyle="Italic" Foreground="Gray" Margin="0,0,0,4" />
                            <Button Content="Add Selected NPCs to Entry" Command="{Binding AddSelectedNpcsToEntryCommand}" Padding="8,2" />
                        </StackPanel>
                    </Grid>
                </TabItem>

                <!-- Factions Tab -->
                <TabItem Header="Factions">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="*" />
                            <RowDefinition Height="Auto" />
                        </Grid.RowDefinitions>
                        <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0,0,0,6">
                            <TextBlock Text="Search:" Style="{DynamicResource {x:Static themes:ResourceKeys.LabelTextStyleKey}}" />
                            <TextBox Text="{Binding FactionSearchText, UpdateSourceTrigger=PropertyChanged}" MinWidth="200" />
                        </StackPanel>
                        <DataGrid Grid.Row="1" ItemsSource="{Binding FilteredFactions}" AutoGenerateColumns="False" CanUserAddRows="False" CanUserDeleteRows="False"
                                  EnableRowVirtualization="True" EnableColumnVirtualization="True">
                            <DataGrid.Columns>
                                <DataGridCheckBoxColumn Header="" Binding="{Binding IsSelected, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" Width="Auto" />
                                <DataGridTextColumn Header="Name" Binding="{Binding DisplayName}" Width="*" IsReadOnly="True" />
                                <DataGridTextColumn Header="EditorID" Binding="{Binding EditorID}" Width="200" IsReadOnly="True" />
                                <DataGridTextColumn Header="FormKey" Binding="{Binding FormKeyString}" Width="150" IsReadOnly="True"
                                                    ElementStyle="{DynamicResource {x:Static themes:ResourceKeys.DataGridFormKeyColumnStyleKey}}" />
                            </DataGrid.Columns>
                        </DataGrid>
                        <Button Grid.Row="2" Content="Add Selected Factions to Entry" Command="{Binding AddSelectedFactionsToEntryCommand}" Padding="8,2" Margin="0,6,0,0" />
                    </Grid>
                </TabItem>

                <!-- Keywords Tab -->
                <TabItem Header="Keywords">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="*" />
                            <RowDefinition Height="Auto" />
                        </Grid.RowDefinitions>
                        <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0,0,0,6">
                            <TextBlock Text="Search:" Style="{DynamicResource {x:Static themes:ResourceKeys.LabelTextStyleKey}}" />
                            <TextBox Text="{Binding KeywordSearchText, UpdateSourceTrigger=PropertyChanged}" MinWidth="200" />
                        </StackPanel>
                        <DataGrid Grid.Row="1" ItemsSource="{Binding FilteredKeywords}" AutoGenerateColumns="False" CanUserAddRows="False" CanUserDeleteRows="False"
                                  EnableRowVirtualization="True" EnableColumnVirtualization="True">
                            <DataGrid.Columns>
                                <DataGridCheckBoxColumn Header="" Binding="{Binding IsSelected, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" Width="Auto" />
                                <DataGridTextColumn Header="EditorID" Binding="{Binding EditorID}" Width="*" IsReadOnly="True" />
                                <DataGridTextColumn Header="FormKey" Binding="{Binding FormKeyString}" Width="150" IsReadOnly="True"
                                                    ElementStyle="{DynamicResource {x:Static themes:ResourceKeys.DataGridFormKeyColumnStyleKey}}" />
                            </DataGrid.Columns>
                        </DataGrid>
                        <Button Grid.Row="2" Content="Add Selected Keywords to Entry" Command="{Binding AddSelectedKeywordsToEntryCommand}" Padding="8,2" Margin="0,6,0,0" />
                    </Grid>
                </TabItem>

                <!-- Races Tab -->
                <TabItem Header="Races">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="*" />
                            <RowDefinition Height="Auto" />
                        </Grid.RowDefinitions>
                        <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0,0,0,6">
                            <TextBlock Text="Search:" Style="{DynamicResource {x:Static themes:ResourceKeys.LabelTextStyleKey}}" />
                            <TextBox Text="{Binding RaceSearchText, UpdateSourceTrigger=PropertyChanged}" MinWidth="200" />
                        </StackPanel>
                        <DataGrid Grid.Row="1" ItemsSource="{Binding FilteredRaces}" AutoGenerateColumns="False" CanUserAddRows="False" CanUserDeleteRows="False"
                                  EnableRowVirtualization="True" EnableColumnVirtualization="True">
                            <DataGrid.Columns>
                                <DataGridCheckBoxColumn Header="" Binding="{Binding IsSelected, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" Width="Auto" />
                                <DataGridTextColumn Header="Name" Binding="{Binding DisplayName}" Width="*" IsReadOnly="True" />
                                <DataGridTextColumn Header="EditorID" Binding="{Binding EditorID}" Width="200" IsReadOnly="True" />
                                <DataGridTextColumn Header="FormKey" Binding="{Binding FormKeyString}" Width="150" IsReadOnly="True"
                                                    ElementStyle="{DynamicResource {x:Static themes:ResourceKeys.DataGridFormKeyColumnStyleKey}}" />
                            </DataGrid.Columns>
                        </DataGrid>
                        <Button Grid.Row="2" Content="Add Selected Races to Entry" Command="{Binding AddSelectedRacesToEntryCommand}" Padding="8,2" Margin="0,6,0,0" />
                    </Grid>
                </TabItem>

                <!-- Classes Tab -->
                <TabItem Header="Classes">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="*" />
                            <RowDefinition Height="Auto" />
                        </Grid.RowDefinitions>
                        <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0,0,0,6">
                            <TextBlock Text="Search:" Style="{DynamicResource {x:Static themes:ResourceKeys.LabelTextStyleKey}}" />
                            <TextBox Text="{Binding ClassSearchText, UpdateSourceTrigger=PropertyChanged}" MinWidth="200" />
                        </StackPanel>
                        <DataGrid Grid.Row="1" ItemsSource="{Binding FilteredClasses}" AutoGenerateColumns="False" CanUserAddRows="False" CanUserDeleteRows="False"
                                  EnableRowVirtualization="True" EnableColumnVirtualization="True">
                            <DataGrid.Columns>
                                <DataGridCheckBoxColumn Header="" Binding="{Binding IsSelected, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" Width="Auto" />
                                <DataGridTextColumn Header="Name" Binding="{Binding DisplayName}" Width="*" IsReadOnly="True" />
                                <DataGridTextColumn Header="EditorID" Binding="{Binding EditorID}" Width="200" IsReadOnly="True" />
                                <DataGridTextColumn Header="FormKey" Binding="{Binding FormKeyString}" Width="150" IsReadOnly="True"
                                                    ElementStyle="{DynamicResource {x:Static themes:ResourceKeys.DataGridFormKeyColumnStyleKey}}" />
                            </DataGrid.Columns>
                        </DataGrid>
                        <Button Grid.Row="2" Content="Add Selected Classes to Entry" Command="{Binding AddSelectedClassesToEntryCommand}" Padding="8,2" Margin="0,6,0,0" />
                    </Grid>
                </TabItem>
            </TabControl>
        </GroupBox>

        <!-- Loading Overlay -->
        <Border Grid.ColumnSpan="3"
                Background="#AA000000"
                Visibility="{Binding IsLoading, Converter={StaticResource BoolToVisConverter}}"
                Panel.ZIndex="100">
            <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
                <ProgressBar IsIndeterminate="True" Width="200" Height="20" Margin="0,0,0,12" />
                <TextBlock Text="{Binding StatusMessage}"
                           Foreground="White"
                           FontSize="14"
                           HorizontalAlignment="Center" />
            </StackPanel>
        </Border>
    </Grid>
</UserControl>
