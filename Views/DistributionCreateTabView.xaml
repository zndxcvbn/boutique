<UserControl x:Class="Boutique.Views.DistributionCreateTabView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             mc:Ignorable="d"
             x:Name="Root"
             d:DesignHeight="600"
             d:DesignWidth="1100">
    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="2*" />
            <ColumnDefinition Width="10" />
            <ColumnDefinition Width="3*" />
        </Grid.ColumnDefinitions>

        <!-- Distribution Entries Editor -->
        <GroupBox Grid.Column="0" Header="Distribution Entries" Padding="6">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="*" />
                    <RowDefinition Height="Auto" />
                </Grid.RowDefinitions>

                <!-- File Selector -->
                <StackPanel Grid.Row="0" Margin="0,0,0,6">
                    <StackPanel Orientation="Horizontal" Margin="0,0,0,6">
                        <TextBlock Text="File:" VerticalAlignment="Center" Margin="0,0,6,0" />
                        <ComboBox ItemsSource="{Binding AvailableDistributionFiles}"
                                  SelectedItem="{Binding SelectedDistributionFile, Mode=TwoWay}"
                                  DisplayMemberPath="DisplayName"
                                  MinWidth="250" Margin="0,0,6,0" />
                        <TextBlock Text="Format:" VerticalAlignment="Center" Margin="12,0,6,0" />
                        <ComboBox ItemsSource="{Binding AvailableFormats}"
                                  SelectedItem="{Binding DistributionFormat, Mode=TwoWay}"
                                  MinWidth="120" Margin="0,0,6,0">
                            <ComboBox.ItemTemplate>
                                <DataTemplate>
                                    <TextBlock Text="{Binding Converter={StaticResource DistributionFileTypeConverter}}" />
                                </DataTemplate>
                            </ComboBox.ItemTemplate>
                        </ComboBox>
                    </StackPanel>
                    <StackPanel Orientation="Horizontal" Visibility="{Binding ShowNewFileNameInput, Converter={StaticResource BoolToVisConverter}}">
                        <TextBlock Text="Filename:" VerticalAlignment="Center" Margin="0,0,6,0" />
                        <TextBox Text="{Binding NewFileName, UpdateSourceTrigger=PropertyChanged}" VerticalAlignment="Center" MinWidth="200" Margin="0,0,6,0" />
                        <Button Content="Browse..." Command="{Binding SelectDistributionFilePathCommand}" Padding="8,2" />
                    </StackPanel>
                    <!-- Conflict Warning -->
                    <Border Margin="0,6,0,0" Padding="8" CornerRadius="4" Visibility="{Binding HasConflicts, Converter={StaticResource BoolToVisConverter}}">
                        <Border.Background><SolidColorBrush Color="#FF8C00" Opacity="0.15" /></Border.Background>
                        <Border.BorderBrush><SolidColorBrush Color="#FF8C00" /></Border.BorderBrush>
                        <Border.BorderThickness><Thickness>1</Thickness></Border.BorderThickness>
                        <StackPanel>
                            <TextBlock Text="{Binding ConflictSummary}" TextWrapping="Wrap" Foreground="#CC6600" FontSize="11" />
                            <StackPanel Orientation="Horizontal" Margin="0,4,0,0">
                                <TextBlock Text="Suggested: " Foreground="#CC6600" FontWeight="Bold" FontSize="11" />
                                <TextBlock Text="{Binding SuggestedFileName}" Foreground="#CC6600" FontFamily="Consolas" FontWeight="Bold" FontSize="11" />
                            </StackPanel>
                        </StackPanel>
                    </Border>
                </StackPanel>

                <!-- Action Buttons -->
                <StackPanel Grid.Row="1" Orientation="Horizontal" Margin="0,0,0,6">
                    <Button Content="Add Entry" Command="{Binding AddDistributionEntryCommand}" Margin="0,0,6,0" Padding="8,2" />
                    <Button Content="Load File" Command="{Binding LoadDistributionFileCommand}" Margin="0,0,6,0" Padding="8,2" />
                    <Button Content="Save File" Command="{Binding SaveDistributionFileCommand}" Padding="8,2" />
                </StackPanel>

                <!-- Distribution Entries List -->
                <ScrollViewer Grid.Row="2" VerticalScrollBarVisibility="Auto">
                    <ItemsControl ItemsSource="{Binding DistributionEntries}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Border BorderBrush="Gray" BorderThickness="1" Margin="0,0,0,6" Padding="6" Cursor="Hand">
                                    <Border.Style>
                                        <Style TargetType="Border">
                                            <Setter Property="BorderBrush" Value="Gray" />
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding IsSelected}" Value="True">
                                                    <Setter Property="BorderBrush" Value="#0078D4" />
                                                    <Setter Property="BorderThickness" Value="2" />
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </Border.Style>
                                    <Grid>
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto" />
                                            <RowDefinition Height="Auto" />
                                            <RowDefinition Height="Auto" />
                                            <RowDefinition Height="Auto" />
                                            <RowDefinition Height="Auto" />
                                            <RowDefinition Height="Auto" />
                                            <RowDefinition Height="Auto" />
                                            <RowDefinition Height="Auto" />
                                            <RowDefinition Height="Auto" />
                                            <RowDefinition Height="Auto" />
                                        </Grid.RowDefinitions>

                                        <!-- Header -->
                                        <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0,0,0,4">
                                            <RadioButton Content="Assign" IsChecked="{Binding IsSelected}"
                                                         Command="{Binding DataContext.SelectEntryCommand, ElementName=Root}"
                                                         CommandParameter="{Binding}" Margin="0,0,12,0" FontWeight="Bold" />
                                            <TextBlock Text="Outfit:" VerticalAlignment="Center" Margin="0,0,6,0" />
                                            <ComboBox ItemsSource="{Binding DataContext.AvailableOutfits, ElementName=Root}"
                                                      SelectedItem="{Binding SelectedOutfit, Mode=TwoWay}"
                                                      DisplayMemberPath="EditorID" MinWidth="200" Margin="0,0,6,0"
                                                      MaxDropDownHeight="300" IsEditable="True" IsTextSearchEnabled="True"
                                                      TextSearch.TextPath="EditorID" DropDownOpened="ComboBox_DropDownOpened" />
                                            <Button Margin="0,0,6,0" Padding="4,2" ToolTip="Preview Outfit" Background="Transparent" BorderThickness="0"
                                                    Command="{Binding DataContext.PreviewEntryCommand, ElementName=Root}" CommandParameter="{Binding}">
                                                <Image Source="pack://application:,,,/Assets/eye.png" Width="16" Height="16" />
                                            </Button>
                                            <Button Content="Remove" Command="{Binding RemoveCommand}" Padding="6,2" />
                                        </StackPanel>

                                        <!-- Chance -->
                                        <StackPanel Grid.Row="1" Orientation="Horizontal" Margin="0,0,0,4">
                                            <CheckBox Content="Use Chance" IsChecked="{Binding UseChance, Mode=TwoWay}" Margin="0,0,8,0" />
                                            <TextBlock Text="Chance (%):" VerticalAlignment="Center" Margin="0,0,6,0" />
                                            <TextBox Text="{Binding Chance, UpdateSourceTrigger=PropertyChanged}" MinWidth="60" IsEnabled="{Binding UseChance}" />
                                            <TextBlock Text="(0-100)" Margin="6,0,0,0" FontStyle="Italic" Foreground="Gray" FontSize="10" />
                                        </StackPanel>

                                        <!-- NPCs -->
                                        <StackPanel Grid.Row="2" Orientation="Horizontal" Margin="0,0,0,4">
                                            <TextBlock Text="NPCs:" Margin="0,0,6,0" />
                                            <TextBlock Text="{Binding SelectedNpcs.Count, StringFormat='{}{0} selected'}" FontStyle="Italic" />
                                        </StackPanel>
                                        <ItemsControl Grid.Row="3" ItemsSource="{Binding SelectedNpcs}">
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate>
                                                    <Border Margin="0,2" Padding="4" BorderBrush="LightGray" BorderThickness="1">
                                                        <StackPanel Orientation="Horizontal">
                                                            <TextBlock Text="{Binding DisplayName}" Margin="0,0,6,0" />
                                                            <TextBlock Text="{Binding FormKeyString}" FontFamily="Consolas" FontSize="10" Margin="0,0,6,0" />
                                                            <Button Content="×" Click="RemoveNpc_Click" Tag="{Binding}" Padding="4,0" Background="Transparent" BorderThickness="0" />
                                                        </StackPanel>
                                                    </Border>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>

                                        <!-- Factions -->
                                        <StackPanel Grid.Row="4" Orientation="Horizontal" Margin="0,4,0,4">
                                            <TextBlock Text="Factions:" Margin="0,0,6,0" />
                                            <TextBlock Text="{Binding SelectedFactions.Count, StringFormat='{}{0} selected'}" FontStyle="Italic" />
                                        </StackPanel>
                                        <ItemsControl Grid.Row="5" ItemsSource="{Binding SelectedFactions}">
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate>
                                                    <Border Margin="0,2" Padding="4" BorderBrush="LightGray" BorderThickness="1">
                                                        <StackPanel Orientation="Horizontal">
                                                            <TextBlock Text="{Binding DisplayName}" Margin="0,0,6,0" />
                                                            <TextBlock Text="{Binding FormKeyString}" FontFamily="Consolas" FontSize="10" Margin="0,0,6,0" />
                                                            <Button Content="×" Click="RemoveFaction_Click" Tag="{Binding}" Padding="4,0" Background="Transparent" BorderThickness="0" />
                                                        </StackPanel>
                                                    </Border>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>

                                        <!-- Keywords -->
                                        <StackPanel Grid.Row="6" Orientation="Horizontal" Margin="0,4,0,4">
                                            <TextBlock Text="Keywords:" Margin="0,0,6,0" />
                                            <TextBlock Text="{Binding SelectedKeywords.Count, StringFormat='{}{0} selected'}" FontStyle="Italic" />
                                        </StackPanel>
                                        <ItemsControl Grid.Row="7" ItemsSource="{Binding SelectedKeywords}">
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate>
                                                    <Border Margin="0,2" Padding="4" BorderBrush="LightGray" BorderThickness="1">
                                                        <StackPanel Orientation="Horizontal">
                                                            <TextBlock Text="{Binding DisplayName}" Margin="0,0,6,0" />
                                                            <TextBlock Text="{Binding FormKeyString}" FontFamily="Consolas" FontSize="10" Margin="0,0,6,0" />
                                                            <Button Content="×" Click="RemoveKeyword_Click" Tag="{Binding}" Padding="4,0" Background="Transparent" BorderThickness="0" />
                                                        </StackPanel>
                                                    </Border>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>

                                        <!-- Races -->
                                        <StackPanel Grid.Row="8" Orientation="Horizontal" Margin="0,4,0,4">
                                            <TextBlock Text="Races:" Margin="0,0,6,0" />
                                            <TextBlock Text="{Binding SelectedRaces.Count, StringFormat='{}{0} selected'}" FontStyle="Italic" />
                                        </StackPanel>
                                        <ItemsControl Grid.Row="9" ItemsSource="{Binding SelectedRaces}">
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate>
                                                    <Border Margin="0,2" Padding="4" BorderBrush="LightGray" BorderThickness="1">
                                                        <StackPanel Orientation="Horizontal">
                                                            <TextBlock Text="{Binding DisplayName}" Margin="0,0,6,0" />
                                                            <TextBlock Text="{Binding FormKeyString}" FontFamily="Consolas" FontSize="10" Margin="0,0,6,0" />
                                                            <Button Content="×" Click="RemoveRace_Click" Tag="{Binding}" Padding="4,0" Background="Transparent" BorderThickness="0" />
                                                        </StackPanel>
                                                    </Border>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </ScrollViewer>

                <!-- Preview -->
                <GroupBox Grid.Row="3" Header="File Preview" Margin="0,6,0,0" Padding="6">
                    <TextBox Text="{Binding DistributionPreviewText, Mode=OneWay}" IsReadOnly="True" TextWrapping="Wrap" AcceptsReturn="True"
                             VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Auto" FontFamily="Consolas" FontSize="11" MinHeight="120" MaxHeight="200" />
                </GroupBox>
            </Grid>
        </GroupBox>

        <!-- Filter Selection -->
        <GroupBox Grid.Column="2" Header="Distribution Filters" Padding="6">
            <TabControl>
                <!-- NPCs Tab -->
                <TabItem Header="NPCs">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="*" />
                            <RowDefinition Height="Auto" />
                        </Grid.RowDefinitions>
                        <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0,0,0,6">
                            <TextBlock Text="Search:" VerticalAlignment="Center" Margin="0,0,6,0" />
                            <TextBox Text="{Binding NpcSearchText, UpdateSourceTrigger=PropertyChanged}" MinWidth="200" />
                        </StackPanel>
                        <DataGrid Grid.Row="1" ItemsSource="{Binding FilteredNpcs}" AutoGenerateColumns="False" CanUserAddRows="False" CanUserDeleteRows="False"
                                  CanUserSortColumns="True" SelectionMode="Single" EnableRowVirtualization="True" EnableColumnVirtualization="True">
                            <DataGrid.Columns>
                                <DataGridCheckBoxColumn Header="" Binding="{Binding IsSelected, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" Width="Auto" />
                                <DataGridTextColumn Header="Name" Binding="{Binding DisplayName}" Width="*" IsReadOnly="True" />
                                <DataGridTextColumn Header="EditorID" Binding="{Binding EditorID}" Width="200" IsReadOnly="True" />
                                <DataGridTextColumn Header="FormKey" Binding="{Binding FormKeyString}" Width="150" IsReadOnly="True">
                                    <DataGridTextColumn.ElementStyle>
                                        <Style TargetType="TextBlock"><Setter Property="FontFamily" Value="Consolas" /><Setter Property="FontSize" Value="10" /></Style>
                                    </DataGridTextColumn.ElementStyle>
                                </DataGridTextColumn>
                                <DataGridTextColumn Header="Mod" Binding="{Binding ModDisplayName}" Width="150" IsReadOnly="True">
                                    <DataGridTextColumn.ElementStyle>
                                        <Style TargetType="TextBlock"><Setter Property="Foreground" Value="Gray" /></Style>
                                    </DataGridTextColumn.ElementStyle>
                                </DataGridTextColumn>
                            </DataGrid.Columns>
                        </DataGrid>
                        <StackPanel Grid.Row="2" Margin="0,6,0,0">
                            <TextBlock Text="{Binding SelectedEntry.SelectedOutfit.EditorID, StringFormat='Target Entry: {0}', FallbackValue='Target Entry: (None selected)'}"
                                       FontStyle="Italic" Foreground="Gray" Margin="0,0,0,4" />
                            <Button Content="Add Selected NPCs to Entry" Command="{Binding AddSelectedNpcsToEntryCommand}" Padding="8,2" />
                        </StackPanel>
                    </Grid>
                </TabItem>

                <!-- Factions Tab -->
                <TabItem Header="Factions">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="*" />
                            <RowDefinition Height="Auto" />
                        </Grid.RowDefinitions>
                        <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0,0,0,6">
                            <TextBlock Text="Search:" VerticalAlignment="Center" Margin="0,0,6,0" />
                            <TextBox Text="{Binding FactionSearchText, UpdateSourceTrigger=PropertyChanged}" MinWidth="200" />
                        </StackPanel>
                        <DataGrid Grid.Row="1" ItemsSource="{Binding FilteredFactions}" AutoGenerateColumns="False" CanUserAddRows="False" CanUserDeleteRows="False"
                                  EnableRowVirtualization="True" EnableColumnVirtualization="True">
                            <DataGrid.Columns>
                                <DataGridCheckBoxColumn Header="" Binding="{Binding IsSelected, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" Width="Auto" />
                                <DataGridTextColumn Header="Name" Binding="{Binding DisplayName}" Width="*" IsReadOnly="True" />
                                <DataGridTextColumn Header="EditorID" Binding="{Binding EditorID}" Width="200" IsReadOnly="True" />
                                <DataGridTextColumn Header="FormKey" Binding="{Binding FormKeyString}" Width="150" IsReadOnly="True">
                                    <DataGridTextColumn.ElementStyle>
                                        <Style TargetType="TextBlock"><Setter Property="FontFamily" Value="Consolas" /><Setter Property="FontSize" Value="10" /></Style>
                                    </DataGridTextColumn.ElementStyle>
                                </DataGridTextColumn>
                            </DataGrid.Columns>
                        </DataGrid>
                        <Button Grid.Row="2" Content="Add Selected Factions to Entry" Command="{Binding AddSelectedFactionsToEntryCommand}" Padding="8,2" Margin="0,6,0,0" />
                    </Grid>
                </TabItem>

                <!-- Keywords Tab -->
                <TabItem Header="Keywords">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="*" />
                            <RowDefinition Height="Auto" />
                        </Grid.RowDefinitions>
                        <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0,0,0,6">
                            <TextBlock Text="Search:" VerticalAlignment="Center" Margin="0,0,6,0" />
                            <TextBox Text="{Binding KeywordSearchText, UpdateSourceTrigger=PropertyChanged}" MinWidth="200" />
                        </StackPanel>
                        <DataGrid Grid.Row="1" ItemsSource="{Binding FilteredKeywords}" AutoGenerateColumns="False" CanUserAddRows="False" CanUserDeleteRows="False"
                                  EnableRowVirtualization="True" EnableColumnVirtualization="True">
                            <DataGrid.Columns>
                                <DataGridCheckBoxColumn Header="" Binding="{Binding IsSelected, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" Width="Auto" />
                                <DataGridTextColumn Header="EditorID" Binding="{Binding EditorID}" Width="*" IsReadOnly="True" />
                                <DataGridTextColumn Header="FormKey" Binding="{Binding FormKeyString}" Width="150" IsReadOnly="True">
                                    <DataGridTextColumn.ElementStyle>
                                        <Style TargetType="TextBlock"><Setter Property="FontFamily" Value="Consolas" /><Setter Property="FontSize" Value="10" /></Style>
                                    </DataGridTextColumn.ElementStyle>
                                </DataGridTextColumn>
                            </DataGrid.Columns>
                        </DataGrid>
                        <Button Grid.Row="2" Content="Add Selected Keywords to Entry" Command="{Binding AddSelectedKeywordsToEntryCommand}" Padding="8,2" Margin="0,6,0,0" />
                    </Grid>
                </TabItem>

                <!-- Races Tab -->
                <TabItem Header="Races">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="*" />
                            <RowDefinition Height="Auto" />
                        </Grid.RowDefinitions>
                        <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0,0,0,6">
                            <TextBlock Text="Search:" VerticalAlignment="Center" Margin="0,0,6,0" />
                            <TextBox Text="{Binding RaceSearchText, UpdateSourceTrigger=PropertyChanged}" MinWidth="200" />
                        </StackPanel>
                        <DataGrid Grid.Row="1" ItemsSource="{Binding FilteredRaces}" AutoGenerateColumns="False" CanUserAddRows="False" CanUserDeleteRows="False"
                                  EnableRowVirtualization="True" EnableColumnVirtualization="True">
                            <DataGrid.Columns>
                                <DataGridCheckBoxColumn Header="" Binding="{Binding IsSelected, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" Width="Auto" />
                                <DataGridTextColumn Header="Name" Binding="{Binding DisplayName}" Width="*" IsReadOnly="True" />
                                <DataGridTextColumn Header="EditorID" Binding="{Binding EditorID}" Width="200" IsReadOnly="True" />
                                <DataGridTextColumn Header="FormKey" Binding="{Binding FormKeyString}" Width="150" IsReadOnly="True">
                                    <DataGridTextColumn.ElementStyle>
                                        <Style TargetType="TextBlock"><Setter Property="FontFamily" Value="Consolas" /><Setter Property="FontSize" Value="10" /></Style>
                                    </DataGridTextColumn.ElementStyle>
                                </DataGridTextColumn>
                            </DataGrid.Columns>
                        </DataGrid>
                        <Button Grid.Row="2" Content="Add Selected Races to Entry" Command="{Binding AddSelectedRacesToEntryCommand}" Padding="8,2" Margin="0,6,0,0" />
                    </Grid>
                </TabItem>
            </TabControl>
        </GroupBox>
    </Grid>
</UserControl>

